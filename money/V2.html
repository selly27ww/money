<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>地址與單號管理系統</title>
    <style>
        /* 原本的樣式 */
    </style>
</head>
<body>
    <h1>地址與單號管理系統</h1>

    <div class="form-container">
        <!-- 表單內容 -->
    </div>

    <div class="container">
        <div class="list">
            <h2>地址列表</h2>
            <ul id="addressList"></ul>
        </div>

        <div class="list">
            <h2>已送達列表</h2>
            <ul id="deliveredList"></ul>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, doc, setDoc, collection, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const firebaseConfig = {
            // Firebase 配置
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let addresses = [];

        async function saveAddressToFirebase(addressData) {
            try {
                const docRef = doc(collection(db, "addresses"));
                await setDoc(docRef, addressData);
                addressData.id = docRef.id;
                console.log("Document written with ID: ", docRef.id);
                alert('地址已成功保存到 Firebase!');
            } catch (error) {
                console.error("Error adding document: ", error);
                alert(`保存失敗，錯誤訊息：${error.message}`);
            }
        }

        async function deleteAddressFromFirebase(id) {
            try {
                await deleteDoc(doc(db, "addresses", id));
                console.log("Document deleted with ID: ", id);
            } catch (error) {
                console.error("Error deleting document: ", error);
            }
        }

        async function fetchAddressesFromFirebase() {
            const querySnapshot = await getDocs(collection(db, "addresses"));
            const addresses = [];
            querySnapshot.forEach((doc) => {
                addresses.push({ id: doc.id, ...doc.data() });
            });
            return addresses;
        }

        async function addAddress() {
            const addressInput = document.getElementById('addressInput');
            const nameInput = document.getElementById('nameInput');
            const phoneInput = document.getElementById('phoneInput');
            const singleNumberInput = document.getElementById('singleNumberInput');
            const carrierSelect = document.getElementById('carrierSelect');
            const noteInput = document.getElementById('noteInput');

            const address = addressInput.value.trim();
            const name = nameInput.value.trim();
            const phone = phoneInput.value.trim();
            const singleNumber = singleNumberInput.value.trim();
            const carrier = carrierSelect.value;
            const note = noteInput.value.trim();
            const status = "未送達";

            if (address && name && phone && singleNumber) {
                const addressData = { address, name, phone, singleNumber, carrier, note, status };

                await saveAddressToFirebase(addressData);

                addresses.push(addressData);
                updateAddressList();
                addressInput.value = '';
                nameInput.value = '';
                phoneInput.value = '';
                singleNumberInput.value = '';
                noteInput.value = '';
            } else {
                alert('請輸入所有欄位內容！');
            }
        }

        function updateAddressList() {
            const addressList = document.getElementById('addressList');
            addressList.innerHTML = '';

            addresses.forEach((entry) => {
                if (entry.status === "未送達") {
                    const li = document.createElement('li');
                    li.className = 'list-item';

                    const content = document.createElement('div');
                    content.className = 'list-item-content';
                    content.innerHTML = `
                        <span>地址：${entry.address}</span>
                        <span>名字：${entry.name}</span>
                        <span>電話：${entry.phone}</span>
                        <span>單號：${entry.singleNumber}</span>
                        <span>運輸方式：${entry.carrier}</span>
                        <span>備註：${entry.note}</span>
                    `;

                    const actions = document.createElement('div');
                    actions.className = 'list-item-actions';

                    const statusSelect = document.createElement('select');
                    const notDeliveredOption = document.createElement('option');
                    notDeliveredOption.value = "未送達";
                    notDeliveredOption.textContent = "未送達";
                    const deliveredOption = document.createElement('option');
                    deliveredOption.value = "已送達";
                    deliveredOption.textContent = "已送達";
                    statusSelect.appendChild(notDeliveredOption);
                    statusSelect.appendChild(deliveredOption);
                    statusSelect.value = entry.status;
                    statusSelect.addEventListener('change', (e) => {
                        entry.status = e.target.value;
                        if (entry.status === "已送達") {
                            updateDeliveredList(entry);
                        }
                    });

                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = '刪除';
                    deleteButton.addEventListener('click', async () => {
                        addresses = addresses.filter(addr => addr.id !== entry.id);
                        await deleteAddressFromFirebase(entry.id);
                        updateAddressList();
                    });

                    actions.appendChild(statusSelect);
                    actions.appendChild(deleteButton);

                    li.appendChild(content);
                    li.appendChild(actions);
                    addressList.appendChild(li);
                }
            });
        }

        function updateDeliveredList(entry) {
            const deliveredList = document.getElementById('deliveredList');
            const li = document.createElement('li');
            li.className = 'list-item';
            li.innerHTML = `
                <span>地址：${entry.address}</span>
                <span>名字：${entry.name}</span>
                <span>電話：${entry.phone}</span>
                <span>單號：${entry.singleNumber}</span>
                <span>運輸方式：${entry.carrier}</span>
                <span>備註：${entry.note}</span>
            `;
            deliveredList.appendChild(li);
            updateAddressList();
        }

        window.onload = async () => {
            addresses = await fetchAddressesFromFirebase();
            updateAddressList();
        };

        window.addAddress = addAddress;
    </script>
</body>
</html>
